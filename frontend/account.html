<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Account - Lost and Found</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="logo" onclick="window.location.href='home.html'">
        LOST & FOUND
      </div>
      <div class="nav-profile-container">
        <nav>
          <a href="home.html">Home</a>
          <a href="items.html">Found Item</a>
          <a href="post.html">Post Item</a>
          <a href="lost.html">Lost Item</a>
        </nav>
        <img src="images/profile-pic.png" alt="profile" class="user-pic" />
        <div class="sub-menu-wrap">
          <div class="sub-menu">
            <div class="user-info">
              <img src="images/profile-pic.png" />
              <h3 id="user-name">User</h3>
            </div>
            <hr />
            <a href="account.html" class="sub-menu-link">
              <img src="images/profile.png" />
              <p>Your Account</p>
              <span>></span>
            </a>
            <a href="#" class="sub-menu-link">
              <img src="images/settings.png" />
              <p>Settings</p>
              <span>></span>
            </a>
            <a href="#" class="sub-menu-link" id="logout-link">
              <img src="images/logout.png" />
              <p>Logout</p>
              <span>></span>
            </a>
            <a href="claims.html" class="sub-menu-link">
              <img src="images/profile.png" />
              <p>Item Claims</p>
              <span>></span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <main id="account-page">
      <div class="account-container">
        <div class="account-section">
          <h3>Profile Information</h3>
          <div class="profile-details">
            <div class="info-row">
              <label>Name:</label>
              <p id="profile-name">Loading...</p>
            </div>

            <div class="info-row">
              <label>Email:</label>
              <p id="profile-email">Loading...</p>
            </div>

            <div class="info-row">
              <label>Phone:</label>
              <p id="profile-phone">Loading...</p>
            </div>

            <div>
              <button id="change-password-btn">Change Password</button>
            </div>
          </div>
        </div>

        <div class="account-section">
          <h3>Your Items</h3>
          <div class="tabs">
            <button class="tab-btn active" data-tab="lost">Lost Items</button>
            <button class="tab-btn" data-tab="found">Found Items</button>
            <button class="tab-btn" data-tab="claimed">Claimed Items</button>
          </div>
          <div class="items-list" id="user-items">
            <p class="loading-text">Loading your items...</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Change Password</h3>
        <form id="change-password-form">
          <div class="form-group">
            <label for="current-password">Current Password:</label>
            <input
              type="password"
              id="current-password"
              name="current_password"
              required
            />
          </div>
          <div class="form-group">
            <label for="new-password">New Password:</label>
            <input
              type="password"
              id="new-password"
              name="new_password"
              required
              minlength="8"
              pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*]).{8,}"
              title="Must contain at least one number, one uppercase and lowercase letter, one special character, and at least 8 or more characters"
            />
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm New Password:</label>
            <input
              type="password"
              id="confirm-password"
              name="confirm_password"
              required
            />
          </div>
          <div
            id="password-error"
            style="color: red; margin-top: 10px; display: none"
          ></div>
          <div class="form-actions">
            <button type="button" id="cancel-password-btn">Cancel</button>
            <button type="submit" id="save-password-btn">
              Change Password
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Toggle profile submenu
      const userPic = document.querySelector(".user-pic");
      const subMenuWrap = document.querySelector(".sub-menu-wrap");

      userPic.addEventListener("click", () => {
        subMenuWrap.classList.toggle("open");
      });

      // Check if user is logged in
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        // Load user profile data
        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          document.getElementById("user-name").textContent = user.name;
          document.getElementById("profile-name").textContent = user.name;
          document.getElementById("profile-email").textContent = user.email;
          document.getElementById("profile-phone").textContent =
            user.phone || "Not provided";
        }

        // Load user items
        loadUserItems("lost");

        // Tab switching functionality
        const tabBtns = document.querySelectorAll(".tab-btn");
        tabBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            tabBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            loadUserItems(btn.dataset.tab);
          });
        });

        // Logout functionality
        document
          .getElementById("logout-link")
          .addEventListener("click", function (e) {
            e.preventDefault();
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "login.html";
          });

        // Set up change password functionality
        setupChangePassword();
      });

      // Function to load user items
      async function loadUserItems(type) {
        const token = localStorage.getItem("token");
        const itemsContainer = document.getElementById("user-items");
        itemsContainer.innerHTML =
          "<p class='loading-text'>Loading your items...</p>";

        try {
          const response = await fetch(
            `http://localhost:5000/api/items/user?type=${type}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          // Check if response is ok before parsing
          if (!response.ok) {
            const text = await response.text();
            console.error("Server response:", text);
            throw new Error(
              `Server returned ${response.status}: ${response.statusText}`
            );
          }

          const data = await response.json();

          if (response.ok) {
            if (!data.data || data.data.length === 0) {
              itemsContainer.innerHTML = `<p class="no-items">You have no ${type} items</p>`;
              return;
            }

            itemsContainer.innerHTML = "";
            data.data.forEach((item) => {
              const itemElement = document.createElement("div");
              itemElement.className = "item-row";

              // Format date
              const itemDate = new Date(item.date).toLocaleDateString();

              itemElement.innerHTML = `
            <div class="item-info">
              <h4>${item.name}</h4>
              <p><strong>Category:</strong> ${item.category}</p>
              <p><strong>Location:</strong> ${item.location}</p>
              <p><strong>Date:</strong> ${itemDate}</p>
              <p><strong>Status:</strong> ${item.status || "Active"}</p>
            </div>
            <div class="item-actions">
              <button class="view-btn" data-id="${
                item._id
              }">View Details</button>
              <button class="delete-btn" data-id="${item._id}">Delete</button>
            </div>
          `;

              itemsContainer.appendChild(itemElement);
            });

            // Add event listeners for buttons
            document.querySelectorAll(".view-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                window.location.href = `item-detail.html?id=${btn.dataset.id}`;
              });
            });

            document.querySelectorAll(".delete-btn").forEach((btn) => {
              btn.addEventListener("click", async () => {
                if (confirm("Are you sure you want to delete this item?")) {
                  await deleteItem(btn.dataset.id);
                  loadUserItems(type);
                }
              });
            });
          } else {
            itemsContainer.innerHTML = `<p class="error-message">${
              data.message || "Failed to load items"
            }</p>`;
          }
        } catch (error) {
          console.error("Error:", error);
          itemsContainer.innerHTML = `<p class="error-message">Error loading items: ${error.message}</p>`;
        }
      }

      // Function to delete an item
      async function deleteItem(itemId) {
        const token = localStorage.getItem("token");
        try {
          const response = await fetch(
            `http://localhost:5000/api/items/${itemId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            const data = await response.json();
            alert(data.message || "Failed to delete item");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error deleting item");
        }
      }

      // Set up change password functionality
      function setupChangePassword() {
        const changePasswordModal = document.getElementById(
          "change-password-modal"
        );
        const changePasswordBtn = document.getElementById(
          "change-password-btn"
        );
        const cancelPasswordBtn = document.getElementById(
          "cancel-password-btn"
        );
        const changePasswordForm = document.getElementById(
          "change-password-form"
        );
        const passwordError = document.getElementById("password-error");

        if (
          !changePasswordBtn ||
          !cancelPasswordBtn ||
          !changePasswordForm ||
          !changePasswordModal
        ) {
          console.error("Some change password elements are missing");
          return;
        }

        // Add modal styles if not already in CSS
        if (!document.getElementById("modal-styles")) {
          const styleEl = document.createElement("style");
          styleEl.id = "modal-styles";
          styleEl.textContent = `
        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
          background-color: #fff;
          margin: 10% auto;
          padding: 20px;
          width: 80%;
          max-width: 500px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
      `;
          document.head.appendChild(styleEl);
        }

        changePasswordBtn.addEventListener("click", () => {
          console.log("Change password button clicked");
          changePasswordForm.reset();
          passwordError.style.display = "none";
          changePasswordModal.style.display = "block";
        });

        cancelPasswordBtn.addEventListener("click", () => {
          changePasswordModal.style.display = "none";
        });

        // Close modals when clicking on the X
        document.querySelectorAll(".close").forEach((closeBtn) => {
          closeBtn.addEventListener("click", () => {
            document.querySelectorAll(".modal").forEach((modal) => {
              modal.style.display = "none";
            });
          });
        });

        // Close modals when clicking outside the modal content
        window.addEventListener("click", (event) => {
          document.querySelectorAll(".modal").forEach((modal) => {
            if (event.target === modal) {
              modal.style.display = "none";
            }
          });
        });

        // Handle form submission
        changePasswordForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          // Validate passwords match
          if (newPassword !== confirmPassword) {
            passwordError.textContent = "New passwords do not match";
            passwordError.style.display = "block";
            return;
          }

          // Validate password complexity
          const passwordRegex =
            /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*]).{8,}$/;
          if (!passwordRegex.test(newPassword)) {
            passwordError.textContent =
              "Password must contain at least 8 characters, including uppercase, lowercase, number, and special character";
            passwordError.style.display = "block";
            return;
          }

          const token = localStorage.getItem("token");
          const user = JSON.parse(localStorage.getItem("user"));

          try {
            const response = await fetch(
              `http://localhost:5000/api/auth/change-password`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  currentPassword,
                  newPassword,
                }),
              }
            );

            const data = await response.json();

            if (response.ok) {
              changePasswordModal.style.display = "none";
              alert("Password changed successfully!");
            } else {
              passwordError.textContent =
                data.message || "Failed to change password";
              passwordError.style.display = "block";
            }
          } catch (error) {
            console.error("Error changing password:", error);
            passwordError.textContent =
              "Error changing password. Please try again.";
            passwordError.style.display = "block";
          }
        });
      }

      async function loadItemResponses(itemId) {
        const token = localStorage.getItem("token");

        try {
          const response = await fetch(
            `http://localhost:5000/api/items/${itemId}/responses`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error(
              `Server returned ${response.status}: ${response.statusText}`
            );
          }

          const data = await response.json();

          // Display the responses
          const responsesContainer = document.getElementById(
            "responses-container"
          );
          responsesContainer.innerHTML = "";

          if (data.data.length === 0) {
            responsesContainer.innerHTML = "<p>No responses yet</p>";
            return;
          }

          data.data.forEach((claim) => {
            const claimElement = document.createElement("div");
            claimElement.className = "claim-card";

            let responsesHtml = "";
            claim.responses.forEach((response) => {
              responsesHtml += `
          <div class="response-item">
            <p><strong>Question:</strong> ${response.questionId.question}</p>
            <p><strong>Answer:</strong> ${response.answer}</p>
          </div>
        `;
            });

            claimElement.innerHTML = `
        <h3>Claim from ${claim.claimantId.name}</h3>
        <p><strong>Status:</strong> ${claim.status}</p>
        <div class="responses">
          ${responsesHtml}
        </div>
        <div class="claim-actions">
          <button class="approve-btn" data-id="${claim._id}">Approve</button>
          <button class="reject-btn" data-id="${claim._id}">Reject</button>
        </div>
      `;

            responsesContainer.appendChild(claimElement);
          });

          // Add event listeners for approve/reject buttons
          document.querySelectorAll(".approve-btn").forEach((btn) => {
            btn.addEventListener("click", () =>
              approveRejectClaim(btn.dataset.id, "approved")
            );
          });

          document.querySelectorAll(".reject-btn").forEach((btn) => {
            btn.addEventListener("click", () =>
              approveRejectClaim(btn.dataset.id, "rejected")
            );
          });
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "responses-container"
          ).innerHTML = `<p class="error-message">Error loading responses: ${error.message}</p>`;
        }
      }

      setupChangePassword();
    </script>
  </body>
</html>
